# Drivers Hub: Backend

```
    ____       _                         __  __      __  
   / __ \_____(_)   _____  __________   / / / /_  __/ /_   
  / / / / ___/ / | / / _ \/ ___/ ___/  / /_/ / / / / __ \  
 / /_/ / /  / /| |/ /  __/ /  (__  )  / __  / /_/ / /_/ /  
/_____/_/  /_/ |___/\___/_/  /____/  /_/ /_/\__,_/_.___/  

```

**Features:**  
0.Multiple Drivers Hubs in one server process  
1.Asynchronous IO (database), making FastAPI really fast  
2.Generic authentication and rate limiting algorithm  
3.Discord / Steam / Password Login & MFA Support  
4.Advanced statistics including summary, chart and details (e.g. the most-driven truck)  
5.Advanced pointing and rewarding system including automatic bonus points / daily bonus points  
6.Role-based permission management  
7.Notification system (Drivers Hub & Discord)  
8.Multiple languages  
9.Multiple plugins and external plugin support  

**Official Plugins**  
Announcement, Application, Banner, Challenge, Division, Downloads, Economy, Event, Poll, Route  

**External Plugins**  
External plugins can add new routes and background tasks to the existing app. It may also modify existing routes by using the same route path.  
To use an external plugin, place the `.py` file in `./external_plugins` folder, add the name of the file to `config.external_plugins` and it'll be automatically loaded.  
To create an external plugin, create a `.py` with `init` function and some route functions. The `init` function must take `config: dict` and `print_log: bool = False` (log should only be written when `print_log = True`) as the only arguments (`def init(app, print_log = False)`) and return `(True, routes: list, states: dict, middlewares: dict)`, or `False` if plugin should not be loaded. It will be called when the plugin is loaded.  
Regarding `middlewares`, it must be a dict with keys no other than `startup`, `request`, `response_ok`, `response_fail`, `error_handler` (not all keys must be provided), the value for each key should either be a callable function or a list of multiple callable functions. The function(s) will be called by the default middleware.  
-> For `startup` middleware, `app` will be passed.  
-> For `request` middleware, `request` will be passed.  
-> For `response_ok` middleware, `request` and `response` will be passed.  
-> For `response_fail` middleware, `request`, `exception` and `traceback` will be passed.  
-> For `error_handler` handler, `request`, `exception` and `traceback` will be passed, it must return a valid `Response` that can be processed by `FastAPI`. If another exception occurs in the handler, the app will fall back to use default error handler. Also, there must be one `error_handler` when loading external plugins, otherwise only the first one will be loaded.  
**Note** To get the `app` when it's not passed directly, use `request.app`. Exceptions should be handled by the middleware, otherwise they will lead to `500` responses.  
Reference: [example.py](./src/external_plugins/example.py)  

**About Banner**  
To save memory when running multiple Drivers Hub, banners are generated by `bannergen` in a separate process. It must be running so that banner function could work.  

**Security API**  
1.Authorization  
`await auth(authorization, request, allow_application_token = False, check_member = True, required_permission = ["admin", "driver"])`  
returns `{error: bool, discordid: int, userid: int, name: str, roles: list, application_token: bool}`  
2.Rate limit  
`await ratelimit(request, endpoint, limittime, limitcnt)`  
When rate limited, returns `(True, JSONResponse)`  
When not rate limited, returns `(False, resp_headers: dict)`  

**More Info?**  
For API documentation, please use [openapi.json](./openapi.json)  

&copy; 2023 [CharlesWithC](https://charlws.com)  
