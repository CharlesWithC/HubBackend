#!/usr/bin/python3

# Copyright (C) 2023 CharlesWithC All rights reserved.
# Author: @CharlesWithC

import argparse
import base64
import json
import os
from datetime import datetime

import uvicorn

import multilang as ml
import routing
from logger import logger

drivershub = """    ____       _                         __  __      __
   / __ \\_____(_)   _____  __________   / / / /_  __/ /_
  / / / / ___/ / | / / _ \\/ ___/ ___/  / /_/ / / / / __ \\
 / /_/ / /  / /| |/ /  __/ /  (__  )  / __  / /_/ / /_/ /
/_____/_/  /_/ |___/\\___/_/  /____/  /_/ /_/\\__,_/_.___/
                                                         """

description = '''Create and start Drivers Hub API Server.

Single or multiple Drivers Hub(s) may be started.
To start single Drivers Hub, use --config.
To start multiple Drivers Hubs within one server process, use --configs or --config-directory, and provide --parent-host, --parent-port, --parent-workers.

If --config is specified, --configs and --config-directory will not be considered. If --configs is specified, --config-directory will not be considered.'''

parser = argparse.ArgumentParser(prog='main', description=description)
parser.add_argument("--config", help = "path to single config file")
parser.add_argument("--configs", help = "path to multiple config files", nargs="*")
parser.add_argument("--config-directory", help = "path to a directory containing multiple config files")
parser.add_argument("--parent-host", help = "parent server host")
parser.add_argument("--parent-port", help = "parent server port", type=int)
parser.add_argument("--parent-workers", help = "parent server workers", type=int)
parser.add_argument("--enable-parent-openapi", help = "enable parent openapi", action='store_true')
parser.add_argument("--parent-openapi-path", help = "set parent openapi path (default /)")
parser.add_argument("--rebuild-dlog-stats", help = "rebuild dlog stats table", action='store_true')
parser.add_argument("--enable-performance-header", help = "add headers telling the response time", action='store_true')
parser.add_argument("--disable-upgrader", help = "prevent running upgrader", action='store_true')
args, _ = parser.parse_known_args() # unknown args generated by uvicorn

config_paths = None
if args.config is not None:
    config_paths = [args.config]
elif args.configs is not None:
    config_paths = args.configs
elif args.config_directory is not None:
    if not os.path.exists(args.config_directory):
        logger.warning("Invalid config-directory, quited.")
        os._exit(42)
    config_files = sorted(os.listdir(args.config_directory))
    config_paths = [os.path.join(args.config_directory, x) for x in config_files]

openapi_path = ""
if args.enable_parent_openapi is True:
    if args.parent_openapi_path is not None:
        openapi_path = args.parent_openapi_path
        if not openapi_path.startswith("/"):
            openapi_path = "/" + openapi_path
    else:
        openapi_path = "/"

if config_paths is not None:
    os.environ["HUB_CONFIG"] = base64.b64encode(json.dumps(config_paths).encode()).decode()
    os.environ["OPENAPI_PATH"] = openapi_path
else:
    if 'HUB_CONFIG' not in os.environ.keys():
        logger.warning("No config is provided, quited.")
        os._exit(42)
    config_paths = json.loads(base64.b64decode(os.environ["HUB_CONFIG"].encode()).decode())
    openapi_path = os.environ["OPENAPI_PATH"]

if __name__ == "__main__":
    from app import version
    currentDateTime = datetime.now()
    date = currentDateTime.date()
    year = date.strftime("%Y")
    for line in drivershub.split("\n"):
        logger.info(line)
    logger.info(f"Drivers Hub: Backend (v{version})")
    logger.info(f"Copyright (C) {year} CharlesWithC All rights reserved.")
    logger.info(f"Languages: {', '.join(ml.LANGUAGES)}")
    logger.info("")

    scopes = routing.initRoutes(config_paths, openapi_path, first_init = True, args = args.__dict__)

scopes = routing.initRoutes(config_paths, openapi_path, args = args.__dict__)

if __name__ == "__main__":
    if scopes is not None:
        uvicorn.run("routing:app", host=scopes["host"], port=scopes["port"], log_level="info", access_log=False, proxy_headers = True, workers = scopes["workers"])
    else:
        if args.parent_host is None or args.parent_port is None:
            logger.warning("--parent-host and --parent-port must be provided when starting multiple Drivers Hubs within one server process, quited.")
            os._exit(42)
        workers = 1 if args.parent_workers is None else args.parent_workers
        uvicorn.run("routing:app", host=args.parent_host, port=args.parent_port, log_level="info", access_log=False, proxy_headers = True, workers = workers)
